# ARI 计算服务

功能：
- 从 ClickHouse 读取分钟级传感器数据
- 每 30 分钟计算一次 ARI1 ~ ARI5+SNOWPACK输出
- 写回 ARI 结果表
## 各类数据的具体处理规则

### 1. 时间基准与回溯策略

- **计算锚点时间（anchor_time）**
  - 以设备在数据库中的 **最新有效分钟数据时间** 作为计算基准
  - 不使用系统当前时间，避免数据延迟导致误判

- **最大可信回溯时间**
  - 统一配置项：`DATA_MAX_LOOKBACK_MIN = 2880`（48 小时）
  - 适用于：
    - 当前时刻数据
    - 24h / 72h 历史取值
    - 所有参与 ARI 计算的变量

- **回溯失败兜底**
  - 若在 48 小时内仍无法找到可信数据：
    - 该变量视为不可用
    - ARI 触发兜底策略：
      - `ARI = 0.0`
      - `ARI 等级 = I`

---

### 2. 置信区间（数据漂移判定规则）

所有传感器原始数据在参与计算前，必须通过置信区间校验。  
超出范围即判定为 **数据漂移（out_of_range）**。

当前采用的置信区间如下（配置于 `SENSOR_CONFIDENCE_RANGE`）：

- **雪深（snow_depth，单位：mm）**
  - 合法范围：`0 ～ 10000`
- **降水量（precipitation，单位：mm，分钟级）**
  - 合法范围：`0 ～ 50`
- **风速（wind_speed，单位：m/s）**
  - 合法范围：`0 ～ 60`
- **气温（atmospheric_temperature，单位：℃）**
  - 合法范围：`-50 ～ 50`

说明：
- 雪深在数据库中存储为 **mm**
- 参与 ARI 计算前统一转换为 **m**
- 任一字段超出置信区间，均不得直接参与计算

---

### 3. 数据漂移处理规则

当变量在目标时刻 **数值存在但超出置信区间** 时：

1. 判定为数据漂移，不使用该值
2. 向前回溯（≤ 48 小时）查找最近一条：
   - 数值存在
   - 且位于置信区间内的数据
3. 若找到：
   - 使用该值作为替代值（fallback）
   - 在结果中标记：`fallback_used@时间`
4. 若未找到：
   - 该变量视为不可用
   - 记录原因：`out_of_range_and_no_fallback`

---

### 4. 数据缺失处理规则

当变量在目标时刻 **无数据（NULL / 无记录）** 时：

- 处理逻辑与数据漂移一致：
  - 允许向前回溯 ≤ 48 小时
  - 查找最近一条可信数据
- 回溯成功：
  - 使用回溯值参与计算
- 回溯失败：
  - 变量不可用
  - 记录原因：`raw_missing`

---

### 5. 对 ARI 计算结果的影响

- 若关键变量（如雪深、24h 增雪量等）：
  - 在回溯窗口内仍无法获得可信值
- 则：
  - ARI 直接进入兜底逻辑
  - 返回结果为：
    - `ARI = 0.0`
    - `ARI 等级 = I`
- 同时保留缺失 / 漂移原因，用于：
  - 前端展示
  - 结果入库
  - 后续数据质量分析